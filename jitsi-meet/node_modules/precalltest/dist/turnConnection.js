/*! precalltest  version = 1.1.4 2017-11-15 */

"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(exports,"__esModule",{value:!0}),exports.TurnConnection=void 0;var _createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),_parsedIceCandidate=require("./utility/parsedIceCandidate"),_getstatshandler=require("./utility/stats/getstatshandler"),_detectbrowser=require("./utility/stats/detectbrowser"),Promise=require("bluebird"),ICE_CHECKING_TIMEOUT=1e4,CONNECTION_TIMEOUT=3e4,TurnConnection=function(){function e(t){_classCallCheck(this,e),this.reset(),this.statshandler=new _getstatshandler.GetStatsHandler(t)}return _createClass(e,[{key:"reset",value:function(){this.iceServers=null,this.pctpc1=null,this.pctpc2=null,this.sendChannel=null,this.messageCallback=null,this.errorCallback=null,this.parsedIceResults={}}},{key:"setMessageCallback",value:function(e){this.messageCallback=e}},{key:"setErrorCallback",value:function(e){this.errorCallback=e}},{key:"send",value:function(e){if(this.sendChannel)try{this.sendChannel.send(e)}catch(e){this.raiseSendError(e)}else this.raiseSendError(new Error("No send channel"))}},{key:"raiseSendError",value:function(e){this.errorCallback&&this.errorCallback(e)}},{key:"assignEvent",value:function(e,t,n){e.addEventListener?e.addEventListener(t,n.bind(this),!1):e.attachEvent&&(t="on"+t,e.attachEvent(t,n.bind(this)))}},{key:"connect",value:function(e){var t=this;this.reset();var n=new Promise(function(e,n){t.resolveCb=e,t.rejectCb=n});this.iceServers=e;var r=null;try{if(RTCPeerConnection?r=RTCPeerConnection:webkitRTCPeerConnection?r=webkitRTCPeerConnection:mozRTCPeerConnection?r=mozRTCPeerConnection:window&&window.RTCPeerConnection&&(r=window.RTCPeerConnection),!r)return this.rejectCb(new Error("RTCPeerConnection not found")),n}catch(e){return this.rejectCb(e),n}var c={ordered:!1,maxRetransmits:0},a={iceTransportPolicy:"all",iceServers:this.iceServers};try{this.pctpc1=new r(a),this.pctpc2=new r(a)}catch(e){return this.rejectDisconnect(e),n}return this.connectionTimer=setTimeout(function(){delete t.connectionTimer,t.rejectDisconnect(new Error("Connection timeout"))},CONNECTION_TIMEOUT),this.sendChannel=this.pctpc1.createDataChannel("precalltest",c),this.sendChannel.binaryType="arraybuffer",this.assignEvent(this.sendChannel,"error",function(e){t.raiseSendError(e),t.rejectDisconnect(e)}),this.assignEvent(this.pctpc2,"datachannel",function(e){var n=e.channel;t.assignEvent(n,"open",function(e){t.resolveCb&&t.resolveCb()}),t.assignEvent(n,"close",function(e){t&&t.disconnect&&t.disconnect()}),t.assignEvent(n,"message",function(e){t.messageCallback&&t.messageCallback(e.data)}),t.assignEvent(n,"error",function(e){t.errorCallback&&t.errorCallback(e),t.rejectDisconnect(e)})}),this.assignEvent(this.pctpc1,"icecandidate",function(e){t.onIceCandidate(t.pctpc1,e)}),this.assignEvent(this.pctpc1,"iceconnectionstatechange",function(e){t.onIceStateChange(t.pctpc1,e)}),this.assignEvent(this.pctpc2,"icecandidate",function(e){t.onIceCandidate(t.pctpc2,e)}),this.assignEvent(this.pctpc2,"iceconnectionstatechange",function(e){t.onIceStateChange(t.pctpc2,e)}),this.pctpc1.createOffer().then(function(e,n){t.onCreateOfferSuccess(e)},function(e){t.onCreateOfferError(t.pctpc1,e)}),n}},{key:"rejectDisconnect",value:function(e){this.rejectCb&&(this.rejectCb(e),this.disconnect())}},{key:"disconnect",value:function(){if(clearTimeout(this.connectionTimer),this.pctpc1)try{this.pctpc1.close()}catch(e){}if(this.pctpc1=null,this.pctpc2)try{this.pctpc2.close()}catch(e){}this.pctpc2=null,this.resolveCb=null,this.rejectCb=null}},{key:"getName",value:function(e){return e===this.pctpc1?"pctpc1":"pctpc2"}},{key:"getOtherPc",value:function(e){return e===this.pctpc1?this.pctpc2:this.pctpc1}},{key:"onCreateOfferError",value:function(e,t){this.rejectDisconnect(t)}},{key:"onCreateAnswerError",value:function(e,t){this.rejectDisconnect(t)}},{key:"onCreateOfferSuccess",value:function(e){var t=this;this.pctpc1.setLocalDescription(e).then(function(){t.onSetLocalSuccess(t.pctpc1)},function(e){t.onSetSessionDescriptionError(t.pctpc1,e)}),this.pctpc2.setRemoteDescription(e).then(function(){t.onSetRemoteSuccess(t.pctpc2)},function(e){t.onSetRemoteSessionDescriptionError(t.pctpc2,e)}),this.pctpc2.createAnswer().then(function(e){t.onCreateAnswerSuccess(e)},function(e){t.onCreateAnswerError(t.pctpc2,e)})}},{key:"onSetLocalSuccess",value:function(e){}},{key:"onSetRemoteSuccess",value:function(e){}},{key:"onSetSessionDescriptionError",value:function(e,t){this.rejectDisconnect(t)}},{key:"onSetRemoteSessionDescriptionError",value:function(e,t){this.rejectDisconnect(t)}},{key:"onCreateAnswerSuccess",value:function(e){var t=this;this.pctpc2.setLocalDescription(e).then(function(){t.onSetLocalSuccess(t.pctpc2)},function(e){t.onSetSessionDescriptionError(t.pctpc2,e)}),this.pctpc1.setRemoteDescription(e).then(function(){t.onSetRemoteSuccess(t.pctpc1)},function(e){t.onSetRemoteSessionDescriptionError(t.pctpc1,e)})}},{key:"onIceCandidate",value:function(e,t){var n=this;if(t.candidate){var r=new _parsedIceCandidate.ParsedIceCandidate(t.candidate);e==this.pctpc1&&this.statshandler.codeBase==_detectbrowser.Constants.codeBaseType.chrome&&(r.isRelay()&&(r.isTypeTransportUdp()&&(this.parsedIceResults.relayUdpGathered=!0),r.isTypeTransportTcp()&&(this.parsedIceResults.relayTcpGathered=!0),r.isTypeTransportTls()&&(this.parsedIceResults.relayTlsGathered=!0)),r.isServerReflexive()&&(this.parsedIceResults.srflxGathered=!0)),r.isRelay()&&this.getOtherPc(e).addIceCandidate(t.candidate).then(function(){n.onAddIceCandidateSuccess(e)},function(t){n.onAddIceCandidateError(e,t,r.isRelay())})}}},{key:"onAddIceCandidateSuccess",value:function(e){}},{key:"onAddIceCandidateError",value:function(e,t,n){n&&this.rejectDisconnect(t)}},{key:"onIceStateChange",value:function(e,t){var n=this,r="(?)";e&&(r=e.iceConnectionState),"failed"===r&&this.rejectDisconnect(new Error("ICE failure")),"checking"!==r||this.iceTimer||(this.iceTimer=setTimeout(function(){delete n.iceTimer,n.rejectDisconnect(new Error("ICE timeout"))},ICE_CHECKING_TIMEOUT)),"completed"!==r&&"connected"!==r||delete this.iceTimer}},{key:"getIceResults",value:function(){var e=this;return new Promise(function(t,n){var r=e.iceServers,c=!0,a=!1,i=void 0;try{for(var s,o=r[Symbol.iterator]();!(c=(s=o.next()).done);c=!0){var l=s.value;r.hasOwnProperty(l)||delete l.credential}}catch(e){a=!0,i=e}finally{try{!c&&o.return&&o.return()}finally{if(a)throw i}}var d={turnIpAddress:"",turnIpVersion:"",turnTransport:"",iceServers:r,ipv6Supported:!1,ipv4Supported:!1,relayTlsGathered:!1,relayTcpGathered:!1,relayUdpGathered:!1,srflxGathered:!1,relayTlsSuccess:!1,relayTcpSuccess:!1,relayUdpSuccess:!1,srflxSuccess:!1};for(var u in e.parsedIceResults)e.parsedIceResults.hasOwnProperty(u)&&(d[u]=e.parsedIceResults[u]);e.pctpc1?e.statshandler.getIceCandidates(e.pctpc1).then(function(e){var n=!0,r=!1,c=void 0;try{for(var a,i=e.iceCandidatePairs[Symbol.iterator]();!(n=(a=i.next()).done);n=!0){var s=a.value;if(s.googActiveConnection||s.selected){var o=!0,l=!1,u=void 0;try{for(var p,h=e.localCandidates[Symbol.iterator]();!(o=(p=h.next()).done);o=!0){var f=p.value,y=null;if(y=f.ip?f.ip:f.ipAddress,f.id==s.localCandidateId){d.turnIpAddress=y;var v=-1!==y.indexOf(":");d.turnIpVersion=v?"ipv6":"ipv4",d.turnTransport=f.mozLocalTransport,!0}"relay"!==f.candidateType&&"relayed"!==f.candidateType||("udp"===f.mozLocalTransport&&(d.relayUdpSuccess=!0),"tcp"===f.mozLocalTransport&&(d.relayTcpSuccess=!0),"tls"===f.mozLocalTransport&&(d.relayTlsSuccess=!0)),-1!==y.indexOf(":")?d.ipv6Supported=!0:d.ipv4Supported=!0}}catch(e){l=!0,u=e}finally{try{!o&&h.return&&h.return()}finally{if(l)throw u}}}}}catch(e){r=!0,c=e}finally{try{!n&&i.return&&i.return()}finally{if(r)throw c}}var C=!0,T=!1,S=void 0;try{for(var m,E=e.localCandidates[Symbol.iterator]();!(C=(m=E.next()).done);C=!0){var b=m.value;"relay"!==b.candidateType&&"relayed"!==b.candidateType||("udp"===b.mozLocalTransport&&(d.relayUdpGathered=!0),"tcp"===b.mozLocalTransport&&(d.relayTcpGathered=!0),"tls"===b.mozLocalTransport&&(d.relayTlsGathered=!0)),"srflx"!==b.candidateType&&"serverreflexive"!==b.candidateType||(d.srflxGathered=!0)}}catch(e){T=!0,S=e}finally{try{!C&&E.return&&E.return()}finally{if(T)throw S}}var I=!0,k=!1,w=void 0;try{for(var g,R=e.iceCandidatePairs[Symbol.iterator]();!(I=(g=R.next()).done);I=!0){var D=g.value;if("succeeded"===D.state){var P=!0,x=!1,j=void 0;try{for(var O,_=e.localCandidates[Symbol.iterator]();!(P=(O=_.next()).done);P=!0){var L=O.value;L.id==D.localCandidateId&&("relay"!==L.candidateType&&"relayed"!==L.candidateType||("udp"===L.mozLocalTransport&&(d.relayUdpSuccess=!0),"tcp"===L.mozLocalTransport&&(d.relayTcpSuccess=!0),"tls"===L.mozLocalTransport&&(d.relayTlsSuccess=!0)),"srflx"!==L.candidateType&&"serverreflexive"!==L.candidateType||(d.srflxSuccess=!0))}}catch(e){x=!0,j=e}finally{try{!P&&_.return&&_.return()}finally{if(x)throw j}}}}}catch(e){k=!0,w=e}finally{try{!I&&R.return&&R.return()}finally{if(k)throw w}}t(d)},function(e){n(e)}):n(new Error("PC not available for stats"))},function(e){reject(e)})}}]),e}();exports.TurnConnection=TurnConnection;