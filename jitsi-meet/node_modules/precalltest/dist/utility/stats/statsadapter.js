/*! precalltest  version = 1.1.4 2017-11-15 */

"use strict";function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(exports,"__esModule",{value:!0}),exports.StatsAdapter=void 0;var _createClass=function(){function t(t,e){for(var a=0;a<e.length;a++){var r=e[a];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,a,r){return a&&t(e.prototype,a),r&&t(e,r),e}}(),_detectbrowser=require("./detectbrowser"),StatsAdapter=function(){function t(e,a){_classCallCheck(this,t),this.codeBase=e,this.browser=a}return _createClass(t,[{key:"getIceCandidates",value:function(t){if(!t)return null;var e=this.extractRawStats(t);return this.processRawStatsForIceInfo(e)}},{key:"extractRawStats",value:function(t){var e=[],a=void 0,r=_detectbrowser.Constants.codeBaseType.firefox,s=_detectbrowser.Constants.codeBaseType.chrome,o=_detectbrowser.Constants.browserName.safari;if(this.codeBase===r&&this.browser!==o)t.forEach(function(t){e.push(t)});else if(this.codeBase===s&&this.browser!==o)t&&t.result?e=t.result():t&&t.forEach&&(e=[],t.forEach(function(t){e.push(t)}));else for(a in t)t.hasOwnProperty(a)&&e.push(t[a]);return e}},{key:"processRawStatsForIceInfo",value:function(t){var e=[],a=[],r=[],s=void 0;if(!t)return null;for(var o=0;o<t.length;++o){var n=this.getParsedStats(t[o]),i=this.statsClassifier(n);if(i.candidatePair)r.push(i.candidatePair);else if(i.transportStats){if("transport"===i.transportStats.type){s=i.transportStats.selectedCandidatePairId;continue}r.push(i.transportStats)}else if(i.localCandidate){var c=i.localCandidate;if("relay"==c.candidateType||"relayed"==c.candidateType){if(!c.mozLocalTransport){var d=c.priority>>24;c.mozLocalTransport=this.formatRelayType(d)}c.mozLocalTransport=c.mozLocalTransport.toLowerCase()}e.push(c)}else i.remoteCandidate&&a.push(i.remoteCandidate)}if(s)for(var l=0;l<r.length;++l)r[l].id===s&&(r[l].googActiveConnection="true");return{localCandidates:e,remoteCandidates:a,iceCandidatePairs:r}}},{key:"getParsedStats",value:function(t){var e={};if(t.timestamp instanceof Date&&(e.timestamp=t.timestamp.getTime().toString()),t.type&&(e.type=t.type),t.names)for(var a=t.names(),r=0;r<a.length;++r)e[a[r]]=t.stat(a[r]);else Object.assign(e,t);if(e.values){var s=!0,o=!1,n=void 0;try{for(var i,c=e.values[Symbol.iterator]();!(s=(i=c.next()).done);s=!0){var d=i.value;Object.assign(e,d)}}catch(t){o=!0,n=t}finally{try{!s&&c.return&&c.return()}finally{if(o)throw n}}delete e.values}return e}},{key:"statsClassifier",value:function(t){var e={},a=function(){for(var e=arguments.length,a=Array(e),r=0;r<e;r++)a[r]=arguments[r];var s=!0,o=!1,n=void 0;try{for(var i,c=a[Symbol.iterator]();!(s=(i=c.next()).done);s=!0){var d=i.value;if(t.type===d)return!0}}catch(t){o=!0,n=t}finally{try{!s&&c.return&&c.return()}finally{if(o)throw n}}return!1},r=a("inbound-rtp","inboundrtp"),s="true"===t.isRemote||!0===t.isRemote;return r||a("outbound-rtp","outboundrtp")?(e.tracks={},e.tracks.data=t,e.tracks.ssrc=t.ssrc,e.tracks.streamType=r?"inbound":"outbound",e.tracks.reportType="local",void 0!==t.isRemote&&(e.tracks.reportType=s?"remote":"local")):a("candidatepair")&&t.selected?e.transportStats=t:a("localcandidate","local-candidate")?e.localCandidate=t:a("remotecandidate","remote-candidate")?e.remoteCandidate=t:a("transport","googCandidatePair")?e.transportStats=t:a("VideoBwe")?e.bwe=t:a("track")?e.trackStats=t:a("candidate-pair")?e.candidatePair=t:a("codec")?e.codec=t:a("ssrc")&&(e.tracks={},e.tracks.data=t,e.tracks.ssrc=t.ssrc,e.tracks.reportType="local",e.tracks.streamType=t.bytesSent?"outbound":"inbound"),e}},{key:"formatRelayType",value:function(t){var e="none";switch(t){case 0:e="tls";break;case 1:e="tcp";break;case 2:e="udp"}return e}}]),t}();exports.StatsAdapter=StatsAdapter;