/*! precalltest  version = 1.1.4 2017-11-15 */

"use strict";function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(exports,"__esModule",{value:!0}),exports.PreCallTest=void 0;var _createClass=function(){function t(t,e){for(var s=0;s<e.length;s++){var n=e[s];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}return function(e,s,n){return s&&t(e.prototype,s),n&&t(e,n),e}}(),_turnConnection=require("./turnConnection"),_rttTest=require("./tests/rttTest"),_throughputTest=require("./tests/throughputTest"),_resultsHandler=require("./utility/resultsHandler"),_onlineCheck=require("./utility/onlineCheck"),_detectbrowser=require("./utility/stats/detectbrowser"),Promise=require("bluebird"),TEST_NAMES={RTT:"rtt",THROUGHPUT:"throughput"},FAILURE_RETRIES=10,PreCallTest=function(){function t(){_classCallCheck(this,t),this.browserInfo=(0,_detectbrowser.detect)(),this.turnConnection=new _turnConnection.TurnConnection(this.browserInfo),this.onlineCheck=new _onlineCheck.OnlineCheck,this.callsInProgress=0,this.turnTests=[TEST_NAMES.RTT,TEST_NAMES.THROUGHPUT],this.active=!1,this.rtt=null,this.resultsHandler=null}return _createClass(t,[{key:"start",value:function(t,e){if(this.browserInfo.browserName!==_detectbrowser.Constants.browserName.msie&&(!window||!window.csioReactNative)&&(this.iceServers=t,this.callback=e,!this.active&&!(this.callsInProgress>0)&&t)){this.turnTestCounter=0,this.resultsHandler=new _resultsHandler.ResultsHandler;var s={type:"browser",os:this.browserInfo.os,osVersion:this.browserInfo.osVersion,buildName:this.browserInfo.browserName,buildVersion:this.browserInfo.browserVersion};this.resultsHandler.add("endpointInfo",s),this.onlineCheck.start(),this.active=!0,this._start()}}},{key:"_start",value:function(){var t=this;this.active&&this.turnConnection.connect(this.iceServers).then(function(){t.active&&t.startTurnTests().then(function(){t.stop()},function(e){t.stop()})},function(e){t.resultsHandler.failure(e),t.resultsHandler.getFailureNumber()>=FAILURE_RETRIES?t.stop():(t.turnConnection.disconnect(),setTimeout(function(){t._start()},0))})}},{key:"stop",value:function(){var t=this;if(this.browserInfo.browserName!==_detectbrowser.Constants.browserName.msie&&this.active){this.active=!1,this.activeTurnTest&&this.activeTurnTest.forceStop();var e=this.onlineCheck.stop();this.resultsHandler.add("onlineStatus",e),this.turnConnection.getIceResults().then(function(e){t.resultsHandler.add("ice",e),t.turnConnection.disconnect(),t.sendResults()},function(e){t.resultsHandler.failure(e),t.turnConnection.disconnect(),t.sendResults()})}}},{key:"sendResults",value:function(){var t=this.resultsHandler.getResults();this.callback&&this.callback(t),this.resultsHandler=null}},{key:"callStarts",value:function(){this.callsInProgress+=1,this.stop()}},{key:"callFinished",value:function(){this.callsInProgress-=1}},{key:"getId",value:function(){return this.resultsHandler?this.resultsHandler.getId():null}},{key:"crashDisconnect",value:function(){try{this.turnConnection.disconnect()}catch(t){}}},{key:"startTurnTests",value:function(){var t=this;if(this.turnTestCounter>=this.turnTests.length)return new Promise(function(t,e){t()});var e=this.turnTests[this.turnTestCounter],s=null;switch(e){case TEST_NAMES.RTT:s=new _rttTest.RttTest(this.turnConnection);break;case TEST_NAMES.THROUGHPUT:s=new _throughputTest.ThroughputTest(this.turnConnection,this.rtt);break;default:return new Promise(function(t,s){s(new Error("Unknown test: "+e))})}return this.activeTurnTest=s,this.active?s.start().then(function(){return t.handleTestResults(e,s.getResults()),t.turnTestCounter+=1,t.activeTurnTest=null,t.startTurnTests()},function(n){return t.handleTestResults(e,s.getResults(),n),t.turnTestCounter+=1,t.activeTurnTest=null,t.startTurnTests()}):new Promise(function(t,e){e(new Error("Test trying to start while testing is not active"))})}},{key:"handleTestResults",value:function(t,e){null==(arguments.length>2&&void 0!==arguments[2]?arguments[2]:null)&&t==TEST_NAMES.RTT&&(this.rtt=e.median),this.resultsHandler&&this.resultsHandler.add(t,e)}}]),t}();exports.PreCallTest=PreCallTest;