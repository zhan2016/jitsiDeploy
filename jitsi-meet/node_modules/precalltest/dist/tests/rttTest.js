/*! precalltest  version = 1.1.4 2017-11-15 */

"use strict";function _interopRequireWildcard(t){if(t&&t.__esModule)return t;var e={};if(null!=t)for(var s in t)Object.prototype.hasOwnProperty.call(t,s)&&(e[s]=t[s]);return e.default=t,e}function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function _inherits(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}Object.defineProperty(exports,"__esModule",{value:!0}),exports.RttTest=void 0;var _createClass=function(){function t(t,e){for(var s=0;s<e.length;s++){var i=e[s];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(e,s,i){return s&&t(e.prototype,s),i&&t(e,i),e}}(),_get=function t(e,s,i){null===e&&(e=Function.prototype);var r=Object.getOwnPropertyDescriptor(e,s);if(void 0===r){var n=Object.getPrototypeOf(e);return null===n?void 0:t(n,s,i)}if("value"in r)return r.value;var u=r.get;if(void 0!==u)return u.call(i)},_timestamps=require("../utility/timestamps"),Timestamps=_interopRequireWildcard(_timestamps),_turnTest=require("./turnTest"),RTTSAMPLES=10,TIMEOUT=100,LAST_TIMEOUT=500,RttTest=function(t){function e(t){_classCallCheck(this,e);var s=_possibleConstructorReturn(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t));return s.sendTimer=null,s.countSent=0,s.rtts=[],s}return _inherits(e,_turnTest.TurnTest),_createClass(e,[{key:"initiate",value:function(){this.results.startTimestamp=Timestamps.getCurrent(),this.sendPing()}},{key:"handleMessage",value:function(t){if(this.isActive()){var e=parseInt(t,10),s=this.calculateRtt(e);this.rtts.push(s),this.countSent<RTTSAMPLES?this.sendPing():this.calculateMetrics()}}},{key:"handleError",value:function(t){this.fillResults(),this.failed(t)}},{key:"sendPing",value:function(){if(this.isActive()){var t=Timestamps.getCurrent();this.send(t.toString()),this.countSent+=1,this.sendTimer&&(clearTimeout(this.sendTimer),this.sendTimer=null),this.countSent<RTTSAMPLES?this.sendTimer=setTimeout(this.sendPing.bind(this),TIMEOUT):this.sendTimer=setTimeout(this.calculateMetrics.bind(this),LAST_TIMEOUT)}}},{key:"calculateRtt",value:function(t){return Timestamps.getCurrent()-t}},{key:"calculateMetrics",value:function(){this.sendTimer&&(clearTimeout(this.sendTimer),this.sendTimer=null),this.fillResults(),this.finished()}},{key:"fillResults",value:function(){this.results.sentMessages=this.countSent,this.results.unAckedMessages=this.countSent-this.rtts.length,this.results.maxMessages=RTTSAMPLES,this.results.forceStopped=this.forceStopped,this.results.median=this.median(),this.results.variance=this.variance(),this.results.endTimestamp=Timestamps.getCurrent()}},{key:"median",value:function(){if(0==this.rtts.length)return null;this.rtts.sort();var t=Math.floor(this.rtts.length/2);return this.rtts[t]}},{key:"variance",value:function(){if(0==this.rtts.length)return null;var t=0,e=this.median(),s=!0,i=!1,r=void 0;try{for(var n,u=this.rtts[Symbol.iterator]();!(s=(n=u.next()).done);s=!0){var o=n.value;t+=Math.abs(o-e)}}catch(t){i=!0,r=t}finally{try{!s&&u.return&&u.return()}finally{if(i)throw r}}return t/=this.rtts.length}},{key:"stop",value:function(){this.isActive()&&(_get(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"stop",this).call(this),this.fillResults())}}]),e}();exports.RttTest=RttTest;