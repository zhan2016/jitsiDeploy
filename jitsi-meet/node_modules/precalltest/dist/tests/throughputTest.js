/*! precalltest  version = 1.1.4 2017-11-15 */

"use strict";function _interopRequireWildcard(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)Object.prototype.hasOwnProperty.call(e,s)&&(t[s]=e[s]);return t.default=e,t}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(exports,"__esModule",{value:!0}),exports.ThroughputTest=void 0;var _createClass=function(){function e(e,t){for(var s=0;s<t.length;s++){var i=t[s];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,s,i){return s&&e(t.prototype,s),i&&e(t,i),t}}(),_get=function e(t,s,i){null===t&&(t=Function.prototype);var r=Object.getOwnPropertyDescriptor(t,s);if(void 0===r){var n=Object.getPrototypeOf(t);return null===n?void 0:e(n,s,i)}if("value"in r)return r.value;var a=r.get;if(void 0!==a)return a.call(i)},_timestamps=require("../utility/timestamps"),Timestamps=_interopRequireWildcard(_timestamps),_messageMaker=require("../utility/messageMaker"),_turnTest=require("./turnTest"),ThroughputTest=function(e){function t(e,s){_classCallCheck(this,t);var i=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));if(i.sentBytes=0,i.receivedBytes=0,i.secondHalfBytes=0,i.secondHalfStart=null,i.bufferEmpty=0,i.chunkSize=1200,i.messageMaker=new _messageMaker.MessageMaker(i.chunkSize),i.duration=5e3,null!=s){var r=50*s;i.duration=Math.max(Math.min(r,1e4),1e3)}return i.sendTimer=null,i.lastMessage=null,i.intervals=[],i.intervalStart=0,i.intervalLength=100,i.intervalBytes=0,i}return _inherits(t,_turnTest.TurnTest),_createClass(t,[{key:"initiate",value:function(){this.startSend()}},{key:"handleMessage",value:function(e){var t=this;if(this.isActive()){this.lastMessage=e,this.receivedBytes+=e.length;var s=Timestamps.getCurrent();if(this.sendTimer||(this.results.startTimestamp=s,this.sendTimer=setTimeout(function(){t.stop(),t.finished()},this.duration)),0==this.intervalStart&&(this.intervalStart=s),this.intervalBytes+=e.length,s-this.intervalStart>=this.intervalLength){var i=s-this.intervalStart,r=this.averageThroughput(this.intervalBytes,i),n=null;try{n=s-JSON.parse(this.lastMessage).timestamp}catch(e){}this.intervals.push({startTimestamp:this.intervalStart,endTimestamp:s,bytesReceived:this.intervalBytes,average:r,rtt:n}),this.intervalStart=s,this.intervalBytes=0}this.results.startTimestamp&&s-this.results.startTimestamp>this.duration/2&&(this.secondHalfStart||(this.secondHalfStart=s),this.secondHalfBytes+=e.length)}}},{key:"handleError",value:function(e){this.stop(),this.failed(e)}},{key:"averageThroughput",value:function(e,t){return e/(t/1e3)*8/1024}},{key:"bufferListener",value:function(){this.sendChannel.removeEventListener("bufferedamountlow",this.bufferListener.bind(this)),this.fillBuffer()}},{key:"fillBuffer",value:function(){for(0==this.sendChannel.bufferedAmount&&(this.bufferEmpty+=1);this.isActive();){if(this.sendChannel.bufferedAmount>this.bufferFullThreshold)return void(this.usePolling?setTimeout(this.fillBuffer.bind(this),250):this.sendChannel.addEventListener("bufferedamountlow",this.bufferListener.bind(this)));var e=this.messageMaker.make(this.sentBytes);this.sentBytes+=e.length,this.send(e)}this.sendChannel.removeEventListener("bufferedamountlow",this.bufferListener.bind(this))}},{key:"startSend",value:function(){this.isActive()&&(this.bufferFullThreshold=1e3*this.chunkSize,this.sendChannel=this.connection.sendChannel,this.usePolling=!0,"number"==typeof this.sendChannel.bufferedAmountLowThreshold&&(this.usePolling=!1,this.sendChannel.bufferedAmountLowThreshold=this.bufferFullThreshold/10),setTimeout(this.fillBuffer.bind(this),0))}},{key:"fillResults",value:function(){this.results.endTimestamp=Timestamps.getCurrent(),this.results.maxDuration=this.duration,this.results.forceStopped=this.forceStopped,this.results.bufferEmpty=this.bufferEmpty,this.results.intervals=this.intervals,this.results.bytesPrepared=this.sentBytes,this.results.bytesReceived=this.receivedBytes;var e=0,t=0;this.secondHalfStart&&(e=this.results.endTimestamp-this.secondHalfStart,t=this.averageThroughput(this.secondHalfBytes,e));var s=this.results.endTimestamp-this.results.startTimestamp,i=this.averageThroughput(this.receivedBytes,s);i>t&&(t=i),this.results.average=t;var r=null;try{r=JSON.parse(this.lastMessage)}catch(e){return}if(r){var n=r.sentBytes+this.lastMessage.length;this.results.bytesSent=n,this.results.fractionLostBytes=1-this.receivedBytes/n}else this.results.bytesSent=-1,this.results.fractionLostBytes=-1}},{key:"stop",value:function(){this.isActive()&&(clearTimeout(this.sendTimer),this.sendTimer=null,_get(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"stop",this).call(this),this.fillResults())}}]),t}();exports.ThroughputTest=ThroughputTest;