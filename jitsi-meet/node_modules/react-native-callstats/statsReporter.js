/*! callstats.js  version = 3.27.0 2017-12-14 */
function PusherPlug(){this.invoker=null,this.receiver=null}function Notifier(){this.listeners=[]}function SenderGate(a){this.stats=null,this.lastResponsed=(new Date).getTime(),this.onDataSent=a}function Measurement(a){this.ssrc=null,this.direction=void 0,this.mediaType=null,this.resolution=null,this.frameRateReceived=null,this.frameWidth=null,this.rtt=null,this.droppedFramesNum=null,this.packetLosts=null,this.jitter=null,this.bytesReceived=-1,this.packetsReceived=-1,this.packetsDiscarded=-1,this.bytesSent=-1,this.packetsSent=-1,this.stream=a}function NumberComparator(a,b){var c="number"==typeof a?a:parseInt(a),d="number"==typeof b?b:parseInt(b);return c===d?0:c<d?-1:1}function MeasurementRTTComparator(a,b){return NumberComparator(a.rtt,b.rtt)}function MeasurementFrameHeightComparator(a,b){return NumberComparator(a.frameHeight,b.frameHeight)}function MeasurementFrameWidthComparator(a,b){return NumberComparator(a.frameWidth,b.frameWidth)}function MeasurementJitterComparator(a,b){return NumberComparator(a.jitter,b.jitter)}function MeasurementFrameRateReceivedComparator(a,b){var c=parseInt(a.frameRateReceived),d=parseInt(b.frameRateReceived);return c===d?0:c<d?-1:1}function MeasurementMerger(a,b){return a}function Assembler(){this.codeBase=null,this.mediaType={unknown:"unknown",audio:"audio",video:"video"},this.codeBaseType={chrome:"Chrome",firefox:"Firefox",edge:"Edge"}}function SWValueTracker(a){SWPlugin.call(this),this.extractorFnc=a,this.prev=0,this.delta=0,this.first=0,this.actual=0,this.addSignalListener(Reporter.Signals.onDataSent,this.onDataSent,this)}function SWValueHolder(a){SWPlugin.call(this),this.extractorFnc=a,this.prev=null}function FractionLost(a,b){this.intervalPacketsRecv=b,this.intervalLoss=a}function FractionLostComparator(a,b){var c=a.getValue(),d=b.getValue();return c===d?0:c<d?-1:1}function FractionLostMerger(a,b){var c=(a.getIntervalLoss()+b.getIntervalLoss())/2,d=(a.getIntervalPacketsRecv()+b.getIntervalPacketsRecv())/2;return new FractionLost(c,d)}function Monitor(){this.measurements=new SlidingWindow(Reporter.maxItemsNum,Reporter.timeoutInMs),this.packetLostTracker=new SWValueTracker(function(a){return a.packetLosts}),this.measurements.addPlugin(this.packetLostTracker),this.packetsDiscardedTracker=new SWValueTracker(function(a){return a.packetsDiscarded}),this.measurements.addPlugin(this.packetsDiscardedTracker),this.resolutionTracker=new SWValueHolder(function(a){return a.resolution}),this.measurements.addPlugin(this.resolutionTracker),this.jitter95PercentileTracker=new SWPercentileTracker(MeasurementJitterComparator,95,MeasurementMerger),this.measurements.addPlugin(this.jitter95PercentileTracker),this.jitter95PercentileTracker.addFilter(function(a){return void 0!==a.jitter&&null!==a.jitter}),this.rtt95PercentileTracker=new SWPercentileTracker(MeasurementRTTComparator,95,MeasurementMerger),this.measurements.addPlugin(this.rtt95PercentileTracker),this.rtt95PercentileTracker.addFilter(function(a){return void 0!==a.rtt&&null!==a.rtt&&0<a.rtt}),this.frameHeight50PercentileTracker=new SWPercentileTracker(MeasurementFrameHeightComparator,50,MeasurementMerger),this.measurements.addPlugin(this.frameHeight50PercentileTracker),this.frameHeight50PercentileTracker.addFilter(function(a){return void 0!==a.frameHeight&&null!==a.frameHeight&&0<a.frameHeight}),this.frameHeight95PercentileTracker=new SWPercentileTracker(MeasurementFrameHeightComparator,95,MeasurementMerger),this.measurements.addPlugin(this.frameHeight95PercentileTracker),this.frameHeight95PercentileTracker.addFilter(function(a){return void 0!==a.frameHeight&&null!==a.frameHeight&&0<a.frameHeight}),this.frameRate50PercentileTracker=new SWPercentileTracker(MeasurementFrameRateReceivedComparator,50,MeasurementMerger),this.measurements.addPlugin(this.frameRate50PercentileTracker),this.frameRate50PercentileTracker.addFilter(function(a){return void 0!==a.frameRateReceived&&null!==a.frameRateReceived}),this.frameRate95PercentileTracker=new SWPercentileTracker(MeasurementFrameRateReceivedComparator,95,MeasurementMerger),this.measurements.addPlugin(this.frameRate95PercentileTracker),this.frameRate95PercentileTracker.addFilter(function(a){return void 0!==a.frameRateReceived&&null!==a.frameRateReceived}),this.frameWidth50PercentileTracker=new SWPercentileTracker(MeasurementFrameWidthComparator,50,MeasurementMerger),this.measurements.addPlugin(this.frameWidth50PercentileTracker),this.frameWidth50PercentileTracker.addFilter(function(a){return void 0!==a.frameWidth&&null!==a.frameWidth&&0<a.frameWidth}),this.frameWidth95PercentileTracker=new SWPercentileTracker(MeasurementFrameWidthComparator,95,MeasurementMerger),this.measurements.addPlugin(this.frameWidth95PercentileTracker),this.frameWidth95PercentileTracker.addFilter(function(a){return void 0!==a.frameWidth&&null!==a.frameWidth&&0<a.frameWidth}),this.rttAvgRTTracker=new SWAvg(function(a){return a.rtt}),this.measurements.addPlugin(this.rttAvgRTTracker),this.rttAvgRTTracker.addFilter(function(a){return void 0!==a.rtt&&null!==a.rtt&&0<a.rtt}),this.frameRateMeanTracker=new SWAvg(function(a){return a.frameRateReceived}),this.measurements.addPlugin(this.frameRateMeanTracker),this.frameRateMeanTracker.addFilter(function(a){return void 0!==a.frameRateReceived&&null!==a.frameRateReceived&&0<a.frameRateReceived}),this.frameHeightMeanTracker=new SWAvg(function(a){return a.frameHeight}),this.measurements.addPlugin(this.frameHeightMeanTracker),this.frameHeightMeanTracker.addFilter(function(a){return void 0!==a.frameHeight&&null!==a.frameHeight&&0<a.frameHeight}),this.frameWidthMeanTracker=new SWAvg(function(a){return a.frameWidth}),this.measurements.addPlugin(this.frameWidthMeanTracker),this.frameWidthMeanTracker.addFilter(function(a){return void 0!==a.frameHeight&&null!==a.frameWidth&&0<a.frameWidth}),this.jitterAvgTracker=new SWAvg(function(a){return a.jitter}),this.measurements.addPlugin(this.jitterAvgTracker),this.jitterAvgTracker.addFilter(function(a){return void 0!==a.jitter&&null!==a.jitter&&0<a.jitter}),this.intervalFractionLosts=new SlidingWindow(Reporter.maxItemsNum,Reporter.timeoutInMs),this.FLPercentileTracker=new SWPercentileTracker(FractionLostComparator,95,FractionLostMerger),this.intervalFractionLosts.addPlugin(this.FLPercentileTracker),this.lastSent=0,this.firstAdded=0,this.lastAdded=0,this.doSending=!1,this.mediaType=null,this.direction=null,this.lastTraffic=0,this.ssrc=0}function InboundMonitor(){Monitor.call(this),this.bytesReceivedTracker=new SWValueTracker(function(a){return a.bytesReceived}),this.packetsReceivedTracker=new SWValueTracker(function(a){return a.packetsReceived}),this.addPlugin(this.bytesReceivedTracker),this.addPlugin(this.packetsReceivedTracker),this.csioIntBRKbpsCount=0,this.csioIntPRCount=0}function InbAudioMonitor(){InboundMonitor.call(this),this.quality={eModel:0,bandwidth:0},this.direction=Measurement.Direction.inbound,this.mediaType=Measurement.MediaTypes.audio}function InbVideoMonitor(){InboundMonitor.call(this),this.frameRateReceivedTracker=new SWValueTracker(function(a){return a.frameRateReceived}),this.frameRatePercTracker=new SWPercentileTracker(MeasurementFrameRateReceivedComparator,10,MeasurementMerger),this.frameRatePercTracker.addFilter(function(a){return void 0!==a.frameRateReceived&&null!==a.frameRateReceived}),this.frameRatePercTracker.attach(this.setFrameRateReceived10,this),this.frameRateReceived10=null,this.addPlugin(this.frameRatePercTracker),this.addPlugin(this.frameRateReceivedTracker),this.quality={eModel:0,bandwidth:0,frameRate:0},this.direction=Measurement.Direction.inbound,this.mediaType=Measurement.MediaTypes.video}function OutboundMonitor(){Monitor.call(this),this.bytesSentTracker=new SWValueTracker(function(a){return a.bytesSent}),this.packetsSentTracker=new SWValueTracker(function(a){return a.packetsSent}),this.addPlugin(this.bytesSentTracker),this.addPlugin(this.packetsSentTracker),this.csioIntBRKbpsCount=0,this.csioIntPRCount=0}function OutbVideoMonitor(){OutboundMonitor.call(this),this.frameRateReceivedTracker=new SWValueTracker(function(a){return a.frameRateReceived}),this.frameRatePercTracker=new SWPercentileTracker(MeasurementFrameRateReceivedComparator,10,MeasurementMerger),this.frameRatePercTracker.addFilter(function(a){return void 0!==a.frameRateReceived&&null!==a.frameRateReceived}),this.frameRatePercTracker.attach(this.setFrameRateReceived10,this),this.frameRateReceived10=null,this.addPlugin(this.frameRatePercTracker),this.addPlugin(this.frameRateReceivedTracker),this.quality={eModel:0,bandwidth:0,frameRate:0},this.sendingThroughputObservations={ssrc:0,started:0,max:0,maxTs:0,stable:0,stableTs:0,ready:!1,maxVerified:!1,stableVerified:!1},this.direction=Measurement.Direction.outbound,this.mediaType=Measurement.MediaTypes.video}function OutbAudioMonitor(){OutboundMonitor.call(this),this.quality={eModel:0,bandwidth:0},this.direction=Measurement.Direction.outbound,this.mediaType=Measurement.MediaTypes.audio}function Monitors(){this.monitors={},this.assembler=new Assembler,this.sendable=!1,this.inbOneWayAudioDisruption={sent:!1,started:0,hasTrafficTs:0},this.outbOneWayAudioDisruption={sent:!1,started:0,hasTrafficTs:0}}function Analyzer(a){this.monitors=new Monitors,this.output=new PusherPlug,this.lastForwarded=(new Date).getTime(),this.lastInterval=0,this.sentCounter=0,this.nextInterval=0,a.addListener(this.monitors.onDataSent,this.monitors),a.addListener(this.onDataSent,this)}function Reporter(){this.states={Idle:"Idle",Run:"Run"},this.events={OnPolling:"OnPolling",OnStatsRequest:"OnStatsRequest",OnStop:"OnStop",OnStart:"OnStart",OnOneWayAudioDisruptionsRequest:"OnOneWayAudioDisruptionsRequest",OnSendingThroughputObservationsRequest:"OnSendingThroughputObservationsRequest"},this.onDataSent=new Notifier,this.analyzer=new Analyzer(this.onDataSent),this.senderGate=new SenderGate(this.onDataSent),this.sendingThroughputObservationsSent=!1,this.analyzer.output.connect(this.senderGate.receiver,this.senderGate),this.currentState=this.states.Run}var SlidingWindow=require("./slidingWindow"),SWPlugin=require("./swPlugin"),SWPercentileTracker=require("./swPercentileTracker"),SWAvg=require("./swAvg");Reporter.disruptions=[],Reporter.adaptiveSending=!0,Reporter.minMeasurementsNum=20,Reporter.SendingTimeTresholds={max:3e4,min:1e3,regular:5e3},Reporter.minDeltaTimeInMs=1e3,Reporter.maxItemsNum=1e3,Reporter.timeoutInMs=3e5,Reporter.Signals={onDataSent:"onDataSent"},PusherPlug.prototype={constructor:PusherPlug,connect:function(a,b){this.invoker=void 0===b?null:b,this.receiver=a},send:function(a){return null===this.receiver?void console.warn("There is no receiver to call"):null===this.invoker?void this.receiver(a):void this.receiver.call(this.invoker,a)}},Notifier.prototype={constructor:Notifier,addListener:function(a,b){this.listeners.push({callback:a,that:b})},notify:function(){for(var a=0;a<this.listeners.length;++a){var b=this.listeners[a];void 0!==b.callback&&null!==b.callback&&(null===b.that?b.callback():b.callback.call(b.that))}}},SenderGate.prototype={constructor:SenderGate,receiver:function(a){this.stats=a,this.initiate=!1},requestStats:function(){var a=null,b=(new Date).getTime();if(null===this.stats)return null;if(this.initiate&&b-Reporter.SendingTimeTresholds.min<this.lastResponsed)return console.warn("Reporter : Too small interval between two sampling to response"),null;var c=b-this.lastResponsed;return console.log("Elapsed time since last report: "+c),a={streams:this.stats},this.stats=null,this.lastResponsed=b,this.onDataSent.notify(),this.initiate=!0,a}},Measurement.MediaTypes={audio:"audio",video:"video"},Measurement.Direction={inbound:"inbound",outbound:"outbound"},Measurement.prototype={constructor:Measurement,toString:function(){return"Measurement {RTT: "+this.RTT+"; }"}},Assembler.prototype={constructor:Assembler,do:function(a,b){var c=new Measurement(a);if(c.ssrc=a.ssrc,c.mediaType=this.getMediaType(a),c.resolution=this.getResolution(a),c.frameRateReceived=this.getFrameRate(a),c.frameWidth=this.getFrameWidth(a),c.frameHeight=this.getFrameHeight(a),c.rtt=this.getLatencyData(a),c.droppedFramesNum=this.getDroppedFramesNum(a),c.packetLosts=this.getPacketLosts(a),c.jitter=this.getJitter(a),a.streamType===Measurement.Direction.inbound?(c.direction=Measurement.Direction.inbound,c.bytesReceived=this.getBytesReceived(a),c.packetsReceived=this.getPacketsReceived(a),c.packetsDiscarded=this.getPacketsDiscarded(a)):a.streamType===Measurement.Direction.outbound&&(c.direction=Measurement.Direction.outbound,c.bytesSent=this.getBytesSent(a),c.packetsSent=this.getPacketsSent(a)),void 0!==b&&b===!0){c.rawdats={};for(var d in a.data)a.data.hasOwnProperty(d)&&(c.rawdats[d]=a.data[d])}return c},setupCodeBase:function(a){this.codeBase=a},getBytesSent:function(a){if(void 0===a.data.bytesSent)return 0;var b=this.checkForNan(parseInt(a.data.bytesSent,10));return null!==b?b:0},getBytesReceived:function(a){if(void 0===a.data.bytesReceived)return 0;var b=this.checkForNan(parseInt(a.data.bytesReceived,10));return null!==b?b:0},getPacketsReceived:function(a){if(void 0===a.data.packetsReceived)return 0;var b=this.checkForNegativeValue(parseInt(a.data.packetsReceived,10));return null!==b?b:0},getPacketsSent:function(a){if(void 0===a.data.packetsSent)return 0;var b=this.checkForNegativeValue(parseInt(a.data.packetsSent,10));return null!==b?b:0},getPacketsDiscarded:function(a){if(void 0===a.data.discardedPackets)return 0;var b=this.checkForNan(parseInt(a.data.discardedPackets,10));return null!==b?b:0},getPacketLosts:function(a){if(void 0===a.data.packetsLost)return 0;var b=this.checkForNegativeValue(parseInt(a.data.packetsLost,10));return null!==b?b:0},getDroppedFramesNum:function(a){if(void 0===a.data.droppedFrames)return 0;var b=this.checkForNegativeValue(parseInt(a.data.droppedFrames,10));return null!==b?b:0},getFrameRate:function(a){var b;return void 0!==a.data.googFrameRateOutput?b=parseInt(a.data.googFrameRateOutput,10):void 0!==a.data.googFrameRateDecoded?b=parseInt(a.data.googFrameRateDecoded,10):void 0!==a.data.googFrameRateReceived?b=parseInt(a.data.googFrameRateReceived,10):void 0!==a.data.googFrameRateSent?b=parseInt(a.data.googFrameRateSent,10):void 0!==a.data.framerateMean&&(b=parseInt(a.data.framerateMean,10)),void 0!==b&&(b=isNaN(b)||b<0?null:b),b},getFrameHeight:function(a){var b;return void 0!==a.data.googFrameHeightReceived?b=a.data.googFrameHeightReceived:void 0!==a.data.googFrameHeightSent?b=a.data.googFrameHeightSent:void 0!==a.data.frameHeight&&(b=a.data.frameHeight),b},getJitter:function(a){if(void 0!==a){var b;return void 0!==a.data.googJitterReceived?(b=this.checkForNan(parseInt(a.data.googJitterReceived,10)),b?b/1e3:b):this.codeBase===this.codeBaseType.chrome&&void 0!==a.data.jitter?(b=this.checkForNan(parseInt(a.data.jitter,10)),b?b/1e3:b):this.codeBase===this.codeBaseType.firefox&&void 0!==a.data.jitter?this.checkForNan(parseInt(a.data.jitter,10)):void 0}},getResolution:function(a){var b,c,d,e="unavailable";return b=this.getFrameRate(a),d=this.getFrameWidth(a),c=this.getFrameHeight(a),void 0!==b&&void 0!==d&&void 0!==c&&d>0&&c>0&&(e=d.concat("x",c,"@",b)),e},getFrameWidth:function(a){var b;return void 0!==a.data.googFrameWidthReceived?b=a.data.googFrameWidthReceived:void 0!==a.data.googFrameWidthSent?b=a.data.googFrameWidthSent:void 0!==a.data.frameWidth&&(b=a.data.frameWidth),b},validateRTT:function(a){var b;return b=isNaN(a)||a<0?null:a},getLatencyData:function(a){return void 0===a?null:void 0!==a.data.googRtt?this.validateRTT(parseInt(a.data.googRtt,10)):void 0!==a.data.roundTripTime?this.validateRTT(parseInt(a.data.roundTripTime,10)):void 0!==a.data.mozRtt?this.validateRTT(parseInt(a.data.mozRtt,10)):null},getMediaType:function(a){var b=this.mediaType.unknown;if(void 0!==a)return a.data&&void 0!==a.data.mediaType?a.data.mediaType:(a.data.mediaType?b=a.data.mediaType:void 0!==a.data.googFrameRateReceived||void 0!==a.data.googFrameRateSent?b=this.mediaType.video:void 0!==a.data.audioInputLevel||void 0!==a.data.audioOutputLevel||void 0!==a.data.audioLevel?b=this.mediaType.audio:void 0!==a.data.framerateMean&&(b=this.mediaType.video),b)},checkForNan:function(a){var b=isNaN(a)?null:a;return b},checkForNegativeValue:function(a){if(a=this.checkForNan(a),null!==a){var b=a<0?null:a;return b}},toString:function(){return"ToString function is not defined. for this object"}},SWValueTracker.prototype=Object.create(SWPlugin.prototype),SWValueTracker.prototype.constructor=SWValueTracker,SWValueTracker.prototype.onDataSent=function(){this.prev=this.actual},SWValueTracker.prototype.getActual=function(){return this.actual},SWValueTracker.prototype.getFirst=function(){return this.first},SWValueTracker.prototype.getDelta=function(){return this.delta=this.actual-this.prev,this.delta},SWValueTracker.prototype.getPrevious=function(){return this.prev},SWValueTracker.prototype.add=function(a){var b=this.extractorFnc(a);if(void 0!==b&&null!==b){if(0===this.first)return this.first=b,void(this.actual=b);this.actual=b,this.notify({last:this.prev,delta:this.delta})}},SWValueTracker.prototype.remove=function(){},SWValueHolder.prototype=Object.create(SWPlugin.prototype),SWValueHolder.prototype.constructor=SWValueHolder,SWValueHolder.prototype.add=function(a){void 0!==a&&null!==a&&(this.prev=this.extractorFnc(a))},SWValueHolder.prototype.remove=function(){},SWValueHolder.prototype.getPrevious=function(){return this.prev},FractionLost.prototype={constructor:FractionLost,getIntervalLoss:function(){return this.intervalLoss},getIntervalPacketsRecv:function(){return this.intervalPacketsRecv},getValue:function(){return void 0===this.intervalPacketsRecv||void 0===this.intervalLoss?null:null===this.intervalPacketsRecv||null===this.intervalLoss?null:0===this.intervalLoss&&0===this.intervalPacketsRecv?0:this.intervalLoss/(this.intervalPacketsRecv+this.intervalLoss)}},Monitor.VideoThroughputThresholds={green:1024,red:256},Monitor.AudioThroughputThresholds={green:30,red:8},Monitor.FrameRateRatioTresholds={green:.8,red:.3},Monitor.VideoRTTThresholds={green:400,red:1e3},Monitor.VideoFractionLostTreshdolds={green:10,red:50},Monitor.AudioFractionLostTresholds={green:15,red:30},Monitor.AudioEModelTresholds={green:240,red:400},Monitor.avQualityRating={excellent:3,fair:2,bad:1},Monitor.avQualityRatingString={excellent:"excellent",fair:"fair",bad:"bad"},Monitor.prototype={constructor:Monitor,doStart:function(){return!0},getStartTime:function(){return this.firstAdded},hasTraffic:function(){var a=this.getLastMeasurement();return this.direction===Measurement.Direction.inbound?0<a.bytesReceived:this.direction===Measurement.Direction.outbound&&0<a.bytesSent},getTotalTimeInMs:function(){return 0===this.firstAdded?0:this.lastAdded-this.firstAdded},getDeltaTimeInMs:function(){return 0===this.lastSent?this.lastAdded-this.firstAdded:this.lastAdded-this.lastSent},getLastMeasurement:function(){return this.measurements.getLast()},setSSRC:function(a){this.ssrc=a},getSSRC:function(){return this.ssrc},add:function(a){var b=(new Date).getTime();if(0===this.firstAdded){if(!this.doStart(a))return;this.firstAdded=b}this.lastAdded=b,this.measurements.add(a)},requestSending:function(){this.doSending=!0},setIntBRAndPR:function(a,b,c){var d=this.getDeltaTimeInMs(),e=Math.max(Reporter.minDeltaTimeInMs,d),f=8*a.getDelta()/e,g=b.getDelta()/(e/1e3);c.data.csioIntBRKbps=f,c.data.csioIntPR=g,0<f?this.csioIntBRKbpsCount=10:0<this.csioIntBRKbpsCount&&(--this.csioIntBRKbpsCount,this.requestSendingIf(1e3<d&&this.csioIntPRCount<5,"OutboundMonitor csioIntBRKbps is 0 and this is the reason for sending")),0<g?this.csioIntPRCount=10:0<this.csioIntPRCount&&(--this.csioIntPRCount,this.requestSendingIf(1e3<d&&this.csioIntPRCount<5,"OutboundMonitor csioIntPR is 0 and this is the reason for sending: "))},requestSendingIf:function(a,b){this.doSending=this.doSending||a},getAvgRTT:function(){return this.rttAvgRTTracker.getResult()},getResolution:function(){return this.resolutionTracker.getPrevious()},percentileTrackerExtractor:function(a,b,c){var d=null,e=a.getResult();return null===e?c:(d=b(e.actual),null===d?c:d)},getRTT95:function(){var a=this.percentileTrackerExtractor(this.rtt95PercentileTracker,function(a){return a.rtt},null),b=this.getLastMeasurement();if(null!==b&&null!==a){var c=Math.max(.1*a,50);this.requestSendingIf(a+c<b.rtt,"RTT95 the reason of sending "+a+" < "+b.rtt)}return a},getJitter95:function(){var a=this.percentileTrackerExtractor(this.jitter95PercentileTracker,function(a){return a.jitter},null),b=this.getLastMeasurement();if(null!==b){var c=Math.max(.1*a,10);this.requestSendingIf(a+c<b.jitter,"Jitter95 the reason of sending "+a+" < "+b.jitter)}return this.result},getFrameRateMean:function(){return this.frameRateMeanTracker.getResult()},getFrameWidth50Percentile:function(){return this.percentileTrackerExtractor(this.frameWidth50PercentileTracker,function(a){return a.frameWidth},null)},getFrameWidth95Percentile:function(){return this.percentileTrackerExtractor(this.frameWidth95PercentileTracker,function(a){return a.frameWidth},null)},getFrameHeight50Percentile:function(){return this.percentileTrackerExtractor(this.frameHeight50PercentileTracker,function(a){return a.frameHeight},null)},getFrameHeight95Percentile:function(){return this.percentileTrackerExtractor(this.frameHeight95PercentileTracker,function(a){return a.frameHeight},null)},getFrameRate50Percentile:function(){return this.percentileTrackerExtractor(this.frameRate50PercentileTracker,function(a){return a.frameRateReceived},null)},getFrameRate95Percentile:function(){return this.percentileTrackerExtractor(this.frameRate95PercentileTracker,function(a){return a.frameRateReceived},null)},getFrameHeightMean:function(){return this.frameHeightMeanTracker.getResult()},getFrameWidthMean:function(){return this.frameWidthMeanTracker.getResult()},getAvgJitter:function(){return this.jitterAvgTracker.getResult()},getQualityEvaluation:function(a,b){if(void 0!==a&&void 0!==b){if(null===a||null===a)return null;var c;return c=b.green<=a?Monitor.avQualityRating.excellent:b.red<a&&a<b.green?Monitor.avQualityRating.fair:Monitor.avQualityRating.bad}},getQualityReverseEvaluation:function(a,b){if(void 0!==a&&void 0!==b){if(null===a||null===a)return null;var c;return c=b.red<a?Monitor.avQualityRating.bad:b.green<=a&&a<=b.red?Monitor.avQualityRating.fair:Monitor.avQualityRating.excellent}},hasData:function(){return this.measurements.refresh(),1<this.measurements.getItemsNum()},addPlugin:function(a){this.measurements.addPlugin(a)},setup:function(a){a.data.csioIntBRKbps=0,a.data.csioAvgBRKbps=0,a.data.csioIntFL=void 0,a.data.csioIntMs=Math.max(Reporter.SendingTimeTresholds.regular,this.getDeltaTimeInMs()),a.data.csioIntPR=void 0,a.data.csioPercentileFl=void 0,a.data.csioIntPktLoss=void 0,a.data.csioAvgJitter=this.getAvgJitter(),a.data.csioAvgRtt=this.getAvgRTT(),a.data.csioPercentileJitter=this.getJitter95(),a.data.csioSig2Latency=this.getRTT95(),a.data.csioTimeElapseMs=this.getTotalTimeInMs(),a.data.csioeM=(null!==this.getRTT95()?this.getRTT95():0)+40,a.data.csiores=this.getResolution(),a.data.csioFrameWidth95Percentile=this.getFrameWidth95Percentile(),a.data.csioFrameWidth50Percentile=this.getFrameWidth50Percentile(),a.data.csioFrameHeight95Percentile=this.getFrameHeight95Percentile(),a.data.csioFrameHeight50Percentile=this.getFrameHeight50Percentile(),a.data.csioFrameRate95Percentile=this.getFrameRate95Percentile(),a.data.csioFrameRate50Percentile=this.getFrameRate50Percentile(),a.data.csioFrameWidthMean=this.getFrameWidthMean(),a.data.csioFrameHeightMean=this.getFrameHeightMean(),a.data.csioFrameRateMean=this.getFrameRateMean()},addIntervalFractionLost:function(a){this.intervalFractionLosts.add(a)},getLastFractionLost:function(){return this.intervalFractionLosts.getLast()},getIntervalFractionLost95:function(){var a,b=this.FLPercentileTracker.getResult();if(null===b)return 0;a=b.actual.getValue();var c=this.getLastFractionLost();if(null!==c&&null!==a){var d=Math.max(.05,c.getValue());this.requestSendingIf(c.getValue()+d<a,"Fraction lost is the reason for sending "+c.getValue()+" "+a)}return a},onDataSent:function(){var a=(new Date).getTime();this.measurements.signalize(Reporter.Signals.onDataSent,null),this.lastSent=a},isValid:function(){for(var a=0;a<arguments.length;a++)if(null===arguments[a]||void 0===arguments[a])return!1;return!0},doSend:function(){if(this.hasData()===!1)return!0;var a=this.doSending;return this.doSending=!1,a},getMediaType:function(){return this.mediaType},getDirection:function(){return this.direction}},InboundMonitor.prototype=Object.create(Monitor.prototype),InboundMonitor.prototype.constructor=InboundMonitor,InboundMonitor.prototype.setRTT95=function(a){Monitor.prototype.setRTT95(a)},InboundMonitor.prototype.setup=function(a){Monitor.prototype.setup.call(this,a);var b=new FractionLost(this.packetLostTracker.getDelta(),this.packetsReceivedTracker.getDelta());this.addIntervalFractionLost(b),a.data.csioIntPktRcv=this.packetsReceivedTracker.getDelta(),this.setIntBRAndPR(this.bytesReceivedTracker,this.packetsReceivedTracker,a),this.getTotalTimeInMs()>0&&(a.data.csioAvgBRKbps=8*this.bytesReceivedTracker.getActual()/this.getTotalTimeInMs()),a.data.csioIntFL=b.getValue(),a.data.csioPercentileFl=this.getIntervalFractionLost95(),a.data.csioeM=(null!==this.getRTT95()?this.getRTT95():0)+40,a.data.csioIntPktLoss=this.packetLostTracker.getDelta(),void 0!==a.data.csioAvgBRKbps&&null!==a.data.csioAvgBRKbps?a.data.csioAvgPacketSize=this.bytesReceivedTracker.getDelta()/this.packetsReceivedTracker.getDelta():a.data.csioAvgPacketSize=null,a.data.csioPktLossPercentage=this.packetLostTracker.getDelta()/this.packetsReceivedTracker.getDelta()*100},InbAudioMonitor.prototype=Object.create(InboundMonitor.prototype),InbAudioMonitor.prototype.constructor=InbAudioMonitor,InbAudioMonitor.prototype.setup=function(a){InboundMonitor.prototype.setup.call(this,a),a.data.csioMediaType=Measurement.MediaTypes.audio,this.quality.eModel=this.getQualityReverseEvaluation(a.data.csioeM,Monitor.AudioEModelTresholds),this.quality.bandwidth=this.getQualityEvaluation(a.data.csioIntBRKbps,Monitor.AudioThroughputThresholds),a.data.csioMark=this.getQuality()},InbAudioMonitor.prototype.getQuality=function(){var a=0,b=.5*this.quality.bandwidth+.5*this.quality.eModel;return b=Math.floor(b),b===Monitor.avQualityRating.excellent?a=Monitor.avQualityRatingString.excellent:b===Monitor.avQualityRating.fair?a=Monitor.avQualityRatingString.fair:b===Monitor.avQualityRating.bad&&(a=Monitor.avQualityRatingString.bad),a},InbVideoMonitor.prototype=Object.create(InboundMonitor.prototype),InbVideoMonitor.prototype.constructor=InbVideoMonitor,InbVideoMonitor.prototype.setFrameRatioQuality=function(){var a=this.frameRateReceivedTracker.getActual(),b=this.frameRateReceivedTracker.getPrevious(),c=0;this.quality.frameRate=0,void 0!==a&&void 0!==b&&null!==a&&null!==b&&0!==b&&(c=a/b,this.quality.frameRate=this.getQualityEvaluation(c,Monitor.FrameRateRatioTresholds))},InbVideoMonitor.prototype.setFrameRateReceived10=function(a){return null===a?void(this.frameRateReceived10=null):void(this.frameRateReceived10=a.actual)},InbVideoMonitor.prototype.setup=function(a){InboundMonitor.prototype.setup.call(this,a),a.data.csioMediaType=Measurement.MediaTypes.video,this.setFrameRatioQuality(),this.quality.eModel=this.getQualityReverseEvaluation(a.data.csioeM,Monitor.AudioEModelTresholds),this.quality.bandwidth=this.getQualityEvaluation(a.data.csioIntBRKbps,Monitor.VideoThroughputThresholds),a.data.csioMark=this.getQuality()},InbVideoMonitor.prototype.getQuality=function(){var a=0,b=.33*this.quality.bandwidth+.33*this.quality.eModel+.33*this.quality.frameRate;return b=Math.floor(b),b===Monitor.avQualityRating.excellent?a=Monitor.avQualityRatingString.excellent:b===Monitor.avQualityRating.fair?a=Monitor.avQualityRatingString.fair:b===Monitor.avQualityRating.bad&&(a=Monitor.avQualityRatingString.bad),a},OutboundMonitor.prototype=Object.create(Monitor.prototype),OutboundMonitor.prototype.constructor=OutboundMonitor,OutboundMonitor.prototype.setup=function(a){Monitor.prototype.setup.call(this,a);var b=new FractionLost(this.packetLostTracker.getDelta(),this.packetsSentTracker.getDelta());this.addIntervalFractionLost(b),this.setIntBRAndPR(this.bytesSentTracker,this.packetsSentTracker,a),this.getTotalTimeInMs()>0&&(a.data.csioAvgBRKbps=8*this.bytesSentTracker.getActual()/this.getTotalTimeInMs()),a.data.csioIntFL=b.getValue(),a.data.csioIntPktRcv=this.packetsSentTracker.getDelta(),a.data.csioPercentileFl=this.getIntervalFractionLost95(),a.data.csioeM=(null!==this.getRTT95()?this.getRTT95():0)+40,a.data.csioIntPktLoss=this.packetLostTracker.getDelta(),void 0!==a.data.csioAvgBRKbps&&null!==a.data.csioAvgBRKbps?a.data.csioAvgPacketSize=this.bytesSentTracker.getDelta()/this.packetsSentTracker.getDelta():a.data.csioAvgPacketSize=null,a.data.csioPktLossPercentage=this.packetLostTracker.getDelta()/this.packetsSentTracker.getDelta()*100},OutbVideoMonitor.verificationElapsedThreshold=1e4,OutbVideoMonitor.initialElapsedThreshold=15e3,OutbVideoMonitor.minStableKBpsSlack=50,OutbVideoMonitor.prototype=Object.create(OutboundMonitor.prototype),OutbVideoMonitor.prototype.constructor=OutbVideoMonitor,OutbVideoMonitor.prototype.setFrameRatioQuality=function(){var a=this.frameRateReceivedTracker.getActual(),b=this.frameRateReceivedTracker.getPrevious(),c=0;this.quality.frameRate=0,void 0!==a&&void 0!==b&&null!==a&&null!==b&&0!==b&&(c=a/b,this.quality.frameRate=this.getQualityEvaluation(c,Monitor.FrameRateRatioTresholds))},OutbVideoMonitor.prototype.setFrameRateReceived10=function(a){return null===a?void(this.frameRateReceived10=null):void(this.frameRateReceived10=a.actual)},OutbVideoMonitor.prototype.getSendingKBitrateObservations=function(){var a=this.sendingThroughputObservations;return a.ready?{ssrc:a.ssrc,maxsendingKBitrate:a.max,timeToMaxSendingKBitrate:a.maxTs-a.started,stablesendingKBitrate:a.stable,timeToStableSendingKBitrate:a.stableTs-a.started}:null},OutbVideoMonitor.prototype.checkSendingKBitrateObservations=function(a){var b=this.sendingThroughputObservations,c=(new Date).getTime();if(b.ready!==!0){if(0===b.started)return b.ssrc=this.getSSRC(),void(b.started=c);var d=a.data.csioIntBRKbps,e=Math.min(OutbVideoMonitor.minStableKBpsSlack,.05*d);b.max<d?(b.max=d,b.maxTs=c):OutbVideoMonitor.verificationElapsedThreshold<c-b.maxTs&&(b.maxVerified=!0),c-b.started<OutbVideoMonitor.initialElapsedThreshold||(d-e<a.data.csioAvgBRKbps&&a.data.csioAvgBRKbps<d+e&&(b.stableTs=c,b.stable=d,b.stableVerified=!0),b.stableVerified&&b.maxVerified&&(b.ready=!0))}},OutbVideoMonitor.prototype.setup=function(a){OutboundMonitor.prototype.setup.call(this,a),a.data.csioMediaType=Measurement.MediaTypes.video,this.setFrameRatioQuality(),this.quality.eModel=this.getQualityReverseEvaluation(a.data.csioeM,Monitor.AudioEModelTresholds),this.quality.bandwidth=this.getQualityEvaluation(a.data.csioIntBRKbps,Monitor.VideoThroughputThresholds),a.data.csioMark=this.getQuality(),this.checkSendingKBitrateObservations(a)},OutbVideoMonitor.prototype.getQuality=function(){var a=0,b=.33*this.quality.bandwidth+.33*this.quality.eModel+.33*this.quality.frameRate;return b=Math.floor(b),b===Monitor.avQualityRating.excellent?a=Monitor.avQualityRatingString.excellent:b===Monitor.avQualityRating.fair?a=Monitor.avQualityRatingString.fair:b===Monitor.avQualityRating.bad&&(a=Monitor.avQualityRatingString.bad),a},OutbAudioMonitor.prototype=Object.create(OutboundMonitor.prototype),OutbAudioMonitor.prototype.constructor=OutbAudioMonitor,OutbAudioMonitor.prototype.setEModelQuality=function(a){a<Monitor.AudioEModelTresholds.green?this.quality.eModel=Monitor.avQualityRating.excellent:a>Monitor.AudioEModelTresholds.green&&a<Monitor.AudioEModelTresholds.red?this.quality.eModel=Monitor.avQualityRating.fair:a>Monitor.AudioEModelTresholds.red&&(this.quality.eModel=Monitor.avQualityRating.bad)},OutbAudioMonitor.prototype.setThroughputQuality=function(a){null!==a&&void 0!==a&&(a>Monitor.AudioThroughputThresholds.green?this.quality.bandwidth=Monitor.avQualityRating.excellent:a>Monitor.AudioThroughputThresholds.red&&a<Monitor.AudioThroughputThresholds.green?this.quality.bandwidth=Monitor.avQualityRating.fair:a<Monitor.AudioThroughputThresholds.red&&(this.quality.bandwidth=Monitor.avQualityRating.bad));
},OutbAudioMonitor.prototype.setup=function(a){OutboundMonitor.prototype.setup.call(this,a),this.setThroughputQuality(a.data.csioIntBRKbps),this.setEModelQuality(a.data.csioeM),a.data.csioMediaType=Measurement.MediaTypes.audio,a.data.csioMark=this.getQuality()},OutbAudioMonitor.prototype.doSend=function(){return this.hasData()===!1,!1},OutbAudioMonitor.prototype.getQuality=function(){var a=0,b=.5*this.quality.bandwidth+.5*this.quality.eModel;return b=Math.floor(b),b===Monitor.avQualityRating.excellent?a=Monitor.avQualityRatingString.excellent:b===Monitor.avQualityRating.fair?a=Monitor.avQualityRatingString.fair:b===Monitor.avQualityRating.bad&&(a=Monitor.avQualityRatingString.bad),a},Monitors.OneWayAudioDisruptionTimeout=5e3,Monitors.DisruptionsMediaType={audio:"audio",video:"video",screen:"screen"},Monitors.DisruptionsType={inbOneWayAudioDisruption:"inbOneWayAudioDisruption",outbOneWayAudioDisruption:"outbOneWayAudioDisruption"},Monitors.prototype={constructor:Monitors,getMonitor:function(a){var b;if(this.monitors[a.direction]&&(b=this.monitors[a.direction][a.ssrc]),void 0!==b)return this.monitors[a.direction][a.ssrc];var c=a.direction===Measurement.Direction.inbound,d=a.direction===Measurement.Direction.outbound,e=a.mediaType===Measurement.MediaTypes.audio,f=a.mediaType===Measurement.MediaTypes.video;return b=c&&e?new InbAudioMonitor:d&&e?new OutbAudioMonitor:c&&f?new InbVideoMonitor:d&&f?new OutbVideoMonitor:null,b.setSSRC(a.ssrc),this.monitors[a.direction]||(this.monitors[a.direction]={}),this.monitors[a.direction][a.ssrc]=b,b},setupCodeBase:function(a){this.assembler.setupCodeBase(a)},isSendable:function(){var a=this.sendable;return this.sendable=!1,a},process:function(a){var b=this.assembler.do(a),c=this.getMonitor(b);return null===c||void 0===c?void console.warn("For ssrc "+b.ssrc+"we do not have monitor"):(c.doSend(b)&&(this.sendable=!0),c.add(b),void c.setup(a))},checkDistortions:function(){var a,b=[],c=[],d=this.monitors[Measurement.Direction.inbound];d&&Object.keys(d).forEach(function(c){a=d[c],a.getMediaType()===Measurement.MediaTypes.audio&&b.push(a)}),d=this.monitors[Measurement.Direction.outbound],d&&Object.keys(d).forEach(function(b){a=d[b],a.getMediaType()===Measurement.MediaTypes.audio&&c.push(a)}),[this.getInbOneWayAudioDisruption(b,c),this.getOutbOneWayAudioDisruption(b,c)].forEach(function(a){a&&Reporter.disruptions.push(a)})},getSendingThroughputObservations:function(){var a=[],b=null,c=this.monitors[Measurement.Direction.outbound];return c?(Object.keys(c).forEach(function(d){b=c[d],b.getMediaType()===Measurement.MediaTypes.video&&a.push(b.getSendingKBitrateObservations())}),a):null},getInbOneWayAudioDisruption:function(a,b){var c=this.inbOneWayAudioDisruption,d=(new Date).getTime();if(c.sent)return null;var e=b.filter(function(a){return 0===a.getStartTime()}).length<1,f=b.filter(function(a){return!a.hasTraffic()}).length<1;if(!e||f)return null;if(!a.length)return null;var g=a.filter(function(a){return!a.hasTraffic()});if(g.length<1)return c.started=0,null;if(0===c.started)return c.started=d,null;if(d-Monitors.OneWayAudioDisruptionTimeout<c.started)return null;var h=g[0].getSSRC();return c.sent=!0,{mediaType:Monitors.DisruptionsMediaType.audio,type:Monitors.DisruptionsType.inbOneWayAudioDisruption,ssrc:h}},getOutbOneWayAudioDisruption:function(a,b){var c=this.outbOneWayAudioDisruption,d=(new Date).getTime();if(c.sent)return null;var e=a.filter(function(a){return 0===a.getStartTime()}).length<1,f=a.filter(function(a){return!a.hasTraffic()}).length<1;if(!e||!f)return null;if(!b.length)return null;var g=b.filter(function(a){return!a.hasTraffic()});if(g.length<1)return c.started=0,null;if(0===c.started)return c.started=d,null;if(d-Monitors.OneWayAudioDisruptionTimeout<c.started)return null;var h=g[0].getSSRC();return c.sent=!0,{mediaType:Monitors.DisruptionsMediaType.audio,type:Monitors.DisruptionsType.outbOneWayAudioDisruption,ssrc:h}},toString:function(){return"ToString function is not defined. for this object"},onDataSent:function(){for(var a in this.monitors)if(this.monitors.hasOwnProperty(a))for(var b in this.monitors[a])if(this.monitors[a].hasOwnProperty(b)){var c=this.monitors[a][b];null!==c?c.onDataSent():console.warn("A Monitor with ssrc: "+b+" should not be null but it is!")}}},Analyzer.prototype={constructor:Analyzer,onDataSent:function(){++this.sentCounter},getSendingThroughputObservations:function(){var a=this.monitors.getSendingThroughputObservations();if(!a)return null;var b=a.filter(function(a){return null===a}).length<1;return b?a:null},receive:function(a){var b=(new Date).getTime(),c=a.streams,d=a.codeBase;this.monitors.setupCodeBase(d);for(var e=0;e<c.length;++e){var f=c[e];this.monitors.process(f)}this.monitors.checkDistortions();var g=!1;if(Reporter.adaptiveSending===!1)g=this.lastForwarded+Reporter.SendingTimeTresholds.regular<b,g&&(this.output.send(c),this.lastInterval=b-this.lastForwarded,this.lastForwarded=b);else{var h=this.monitors.isSendable();if(0===this.sentCounter?g=!0:this.sentCounter<5?(g=this.lastForwarded+Reporter.SendingTimeTresholds.regular<b,h=!1):g=this.lastForwarded+Math.min(Reporter.SendingTimeTresholds.max,this.nextInterval)<b,g||h)if(this.output.send(c),this.lastInterval=b-this.lastForwarded,this.lastForwarded=b,h)this.lastInterval=Math.max(Reporter.SendingTimeTresholds.min,this.lastInterval/2);else if(g){var i=Math.random()+1;this.nextInterval=Math.min(Reporter.SendingTimeTresholds.max,this.lastInterval*i)}}}},Reporter.prototype={constructor:Reporter,fire:function(a){var b;switch(this.currentState){case this.states.Idle:switch(a){case this.events.OnStart:this.currentState=this.states.Run;break;default:console.warn("Unhandled event "+a+" in "+this.currentState+" mode")}break;case this.states.Run:switch(a){case this.events.OnStop:this.currentState=this.states.Idle;break;case this.events.OnPolling:var c=arguments[1];this.analyzer.receive(c);break;case this.events.OnOneWayAudioDisruptionsRequest:if(b=arguments[1],void 0===b){console.warn("OnStatsRequest event required a parameter to store the response");break}0<Reporter.disruptions.length&&(b.response=Reporter.disruptions,Reporter.disruptions=[]);break;case this.events.OnSendingThroughputObservationsRequest:if(b=arguments[1],void 0===b){console.warn("OnSendingThroughputObservationsRequest event required a parameter to store the response");break}this.sendingThroughputObservationsSent===!1&&(b.response=this.analyzer.getSendingThroughputObservations(),this.sendingThroughputObservationsSent=null!==b.response);break;case this.events.OnStatsRequest:if(b=arguments[1],void 0===b){console.warn("OnStatsRequest event required a parameter to store the response");break}b.response=this.senderGate.requestStats();break;default:console.warn("Unhandled event "+a+" in "+this.currentState+" mode")}break;default:console.error("The Reporter machine is in an unkown state: "+this.currentState)}},toString:function(){return"Reporter is in "+this.currentState},setReportingMode:function(a){Reporter.adaptiveSending=a===!0},setSubmissionInterval:function(a){Reporter.SendingTimeTresholds.regular=a,Reporter.adaptiveSending?(Reporter.SendingTimeTresholds.min=1e3,Reporter.SendingTimeTresholds.max=3e4):(Reporter.SendingTimeTresholds.min=a,Reporter.SendingTimeTresholds.max=a)}},module.exports.Reporter=Reporter;